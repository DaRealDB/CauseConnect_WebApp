rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is participant
    function isParticipant(conversation) {
      return isAuthenticated() && 
             request.auth.uid in conversation.data.participants;
    }
    
    // Helper function to check if user is admin (for group chats)
    function isAdmin(conversation) {
      return isAuthenticated() && 
             conversation.data.adminId == request.auth.uid;
    }
    
    // Helper function to check if user is sender
    function isSender(message) {
      return isAuthenticated() && 
             message.data.senderId == request.auth.uid;
    }
    
    // ==================== CONVERSATIONS ====================
    match /conversations/{conversationId} {
      
      // Allow read if user is a participant
      allow read: if isParticipant(resource);
      
      // Allow create if authenticated and user is in participants
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      // Allow update if user is participant
      // Admin can update group settings
      allow update: if isParticipant(resource) && (
                       // Regular participants can update lastMessage, etc.
                       (!('adminId' in resource.data) || resource.data.adminId == null) ||
                       // Or if updating group settings, must be admin
                       (('adminId' in request.resource.data) && isAdmin(resource))
                     );
      
      // Allow delete only for admins or if private chat
      allow delete: if isAuthenticated() && (
                       resource.data.type == 'private' ||
                       (resource.data.type == 'group' && isAdmin(resource))
                     );
      
      // ==================== MESSAGES ====================
      match /messages/{messageId} {
        
        // Allow read if user is participant in conversation
        allow read: if isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)));
        
        // Allow create if user is participant and is the sender
        allow create: if isAuthenticated() && 
                         isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId))) &&
                         request.resource.data.senderId == request.auth.uid;
        
        // Allow update if user is sender (for editing) or participant (for readBy)
        allow update: if isAuthenticated() && 
                         isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId))) && (
                           // Sender can edit their message
                           resource.data.senderId == request.auth.uid ||
                           // Any participant can update readBy (to mark as read)
                           (!resource.data.diff(request.resource.data).affectedKeys().hasOnly(['readBy'])) ||
                           // Sender can delete their message
                           (request.resource.data.deleted == true && resource.data.senderId == request.auth.uid)
                         );
        
        // Allow delete (soft delete) if user is sender
        allow delete: if isAuthenticated() && 
                         isSender(resource);
      }
      
      // ==================== TYPING INDICATORS ====================
      match /typing/{typingId} {
        allow read: if isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)));
        allow create: if isAuthenticated() && 
                         request.resource.data.userId == request.auth.uid &&
                         isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)));
        allow update: if isAuthenticated() && 
                         resource.data.userId == request.auth.uid;
        allow delete: if isAuthenticated() && 
                         resource.data.userId == request.auth.uid;
      }
    }
    
    // ==================== USER PRESENCE ====================
    match /presence/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId;
    }
    
    // ==================== BLOCKED USERS ====================
    match /blocked/{blockId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ==================== MUTED CONVERSATIONS ====================
    match /muted/{muteId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
  }
}


